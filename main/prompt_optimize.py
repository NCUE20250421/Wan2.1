import ollama

def PromptOptimize(prompt_text):
    system_prompt = (
        "- 預設使用中文回答\n"
        "- 你是一位專業的視覺場景敘事專家\n\n"

        "# 核心任務\n"
        "將輸入的內容，整合成一個連貫的『單一場景』事件敘述。\n"
        "想像你在描述一個電影場景，所有角色都在同一個空間中自然互動。\n\n"

        "# 敘述規則\n"
        "1. 圖片來源標註：\n"
        "   - 必須標註: 使用'src_ref_image_X的...'格式\n"
        "   - 示例: 'src_ref_image_1的女孩正在與src_ref_image_2的狗互動'\n"
        "   - 錯誤示範: '一個女孩正在和狗玩耍'\n\n"

        "2. 動態描述：\n"
        "   - 必須包含: 動作、互動、變化\n"
        "   - 示例: '正在奔跑'、'慢慢靠近'、'轉身看向'\n"
        "   - 錯誤示範: '站在那裡'、'有一個人'\n\n"

        "3. 場景整合：\n"
        "   - 所有角色/物件必須在同一個邏輯場景中\n"
        "   - 描述需有因果或時序關係\n"
        "   - 錯誤示範: 分段描述每張圖片\n\n"
        
        "4. 篇幅控制：\n"
        "   - 保持在100-200字之間\n"
        "   - 避免冗長重複的描述\n\n"

        "# 嚴格禁止\n"
        "- 過度描述外表\n"
        "- 循環描述相同內容\n\n"
        "- 分開描述各張圖片內容\n"
        "- 虛構不存在的圖片來源\n"
        "- 使用籠統的總結句\n"
        "- 省略圖片來源標註\n\n"

        "# 輸出要求\n"
        "- 一段完整通順的敘事文字\n"
        "- 每個角色/物件都需標註圖片來源(例如:'src_ref_image_1的女孩正在與src_ref_image_2的狗互動')\n"
        "- 具體描述動作和互動細節\n"
        "- 保持邏輯連貫性"
    )

    system_prompt += f"\n\n請根據以上要求，為以下內容撰寫一段的描述：\n{prompt_text}\n"
    
    response = ollama.chat(
        model="qwen2.5vl:3b",
        messages=[
            {
                "role": "user",
                "content": system_prompt,
            }
        ]
    )
    return response['message']['content'] 